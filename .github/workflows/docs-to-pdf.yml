name: Docs to PDF

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - test
    paths-ignore:
      - "website/static/un-transparency-protocol.pdf"

jobs:
  docs-to-pdf:
    name: Generates PDF file from docs
    runs-on: ubuntu-latest
    env:
      # Use an absolute path for Puppeteer's download directory.
      PUPPETEER_DOWNLOAD_PATH: /home/runner/.cache/puppeteer
    permissions:
      contents: "write"
      actions: "read"
    concurrency:
      group: pdf
      cancel-in-progress: true
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      # Cache Puppeteerâ€™s Chromium download
      - name: Cache Puppeteer Chromium
        uses: actions/cache@v3
        with:
          path: /home/runner/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-chromium-v3

      # Install global packages.
      - name: Install fs-extra
        run: npm install -g fs-extra

      - name: Install docs-to-pdf
        run: npm install -g docs-to-pdf

      - name: Generate PDF
        run: |
          echo "waiting for two minutes for GitHub pages to be deployed..."
          npx docs-to-pdf --initialDocURLs="https://uncefact.github.io/spec-untp/docs/about/?t=${{ github.run_id }}" \
            --excludePaths="/docs/implementations/" \
            --contentSelector="article" \
            --paginationSelector="a.pagination-nav__link pagination-nav__link--next" \
            --excludeSelectors=".breadcrumbs,.theme-edit-this-page" \
            --excludeURLs="https://uncefact.github.io/spec-untp/docs/about/Meetings,https://uncefact.github.io/spec-untp/docs/about/FAQ" \
            --outputPDFFilename="website/static/un-transparency-protocol.pdf" \
            --coverTitle="UN Transparency Protocol" \
            --coverImage="https://uncefact.github.io/spec-untp/img/home-hero.jpg" \
            --puppeteerArgs="--no-sandbox,--disable-setuid-sandbox,--disable-http-cache" \
            --cssStyle="body { font-size: 13.33px !important; } h1 { font-size: 40px !important; } h2 { font-size: 26.67px !important; }"

      - name: Commit PDF
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add website/static/un-transparency-protocol.pdf
          git commit -m "chore: update PDF file" || echo "No changes to commit"
          git push